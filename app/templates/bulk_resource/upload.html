{% extends 'layouts/base.html' %}
{% import 'macros/form_macros.html' as f %}

{% block content %}
    <div class="ui stackable centered grid container">
        <div class="twelve wide column">
            <h2 class="ui header">
                Upload
            </h2>
            <form id="csv-upload-form" class="ui form">
                <div class="field">
                    <label for="csv">CSV File</label>
                    <input id="csv-file" name="csv" placeholder="CSV File" type="file">
                </div>
                <button class="ui button" type="submit">Upload</button>
            </form>
        </div>
    </div>

    <div class="ui modal">
        <i class="close icon"></i>
        <div class="header">
            Your CSV file has some errors
        </div>
        <div class="image content">
            <div class="description">
                <div id="errors">
                </div>
            </div>
        </div>
        <div class="actions">
            <div class="ui right labeled button">
                Thanks
            </div>
        </div>
    </div>

    <script type="text/javascript">

        $("#csv-upload-form").submit(function(event) {

            event.preventDefault();
            $("#csv-file").parse({
				config: {
				    complete: function(results, file) {
				        // Check that CSV data is formatted correctly.
				        var errorList = [];
				        var csvData = results.data;
				        var numColumns = csvData[0].length;
				        for (var i = 1; i < csvData.length; i++) {
				            if (csvData[i].length != numColumns) {
				                errorList.push("Row " + (i + 1) + " has the incorrect number of columns.");
				            }
				        }

				        // Check that CSV data contains the correct headers.
				        var columnNames = csvData[0];
				        if (columnNames.indexOf("Name") == -1) {
				            errorList.push("'Name' is a required column name.");
				        }
				        if (columnNames.indexOf("Address") == -1) {
				            errorList.push("'Address' is a required column name.");
				        }

				        if (errorList.length > 0) {
				            $("#errors").empty();
				            for (var i = 0; i < errorList.length; i++) {
                                $("#errors").append("<p>" + errorList[i] + "</p>");
				            }
                            $(".ui.modal").modal("show");
				        } else {
				            $.ajax({
                                url: "{{ url_for('bulk_resource.upload_data') }}",
                                data: JSON.stringify(results.data),
                                dataType: "json",
                                type: "GET",
                                mimeType: "application/json",
                                success: function (data) {
                                    if (data.redirect) {
                                        window.location.href = data.redirect;
                                    }
                                },
                                error: function (errorMessage) { }
                            });
				        }
                    }
				},
				before: function(file, inputElem) { },
				error: function(error, file) {
				    $("#errors").empty();
				    $("#errors").append("<p>" + error + "</p>");
				    $(".ui.modal").modal("show");
				},
				complete: function() {
				    // Redirect to next page.
					console.log("Done with all files");
				}
			});
        });

    </script>
{% endblock %}
