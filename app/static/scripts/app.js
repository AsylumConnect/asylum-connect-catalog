var mobileBreakpoint=768;var tabletBreakpoint=992;var smallMonitorBreakpoint=1200;var singleColNoSpaceBreakpoint=500;var singleColBreakpoint=800;var twoColResizeBreakpoint=1150;$(document).ready(function(){$('.message .close').on('click',function(){$(this).parent().fadeOut();});$('#open-nav').on('click',function(){$('.mobile.only .vertical.menu').transition('slide down');});$('.dropdown').dropdown();$('select').dropdown();});(function($){function icontains(elem,text){return(elem.textContent||elem.innerText||$(elem).text()||"").toLowerCase().indexOf((text||"").toLowerCase())>-1;}
$.expr[':'].icontains=$.expr.createPseudo?$.expr.createPseudo(function(text){return function(elem){return icontains(elem,text);};}):function(elem,i,match){return icontains(elem,match[3]);};})(jQuery);var currentState=[];function changeMenu(e){var children=$($(e).children()[1]).html();children+='<a class="item" onClick="back()">Back</a><i class="back icon"></i>';currentState.push($('.mobile.only .vertical.menu').html());$('.mobile.only .vertical.menu').html(children);}
function back(){$('.mobile.only .vertical.menu').html(currentState.pop());}
$(document).ready(function(){$('#search-descriptors').keyup(function(){var searchText=$(this).val();if(searchText.length>0){$('tbody td.descriptor-name:icontains('+searchText+')').addClass('positive');$('td.descriptor-name.positive').not(':icontains('+searchText+')').removeClass('positive');$('tbody td.descriptor-name').not(':icontains('+searchText+')').closest('tr').addClass('hidden').hide();$('tr.hidden:icontains('+searchText+')').has('td.descriptor-name:icontains('+searchText+')').removeClass('hidden').show();}else{$('td.descriptor-name.positive').removeClass('positive');$('tr.hidden').removeClass('hidden').show();}});$('.deletion.checkbox').checkbox({onChecked:function(){$('.deletion.button').removeClass('disabled');},onUnchecked:function(){$('.deletion.button').addClass('disabled');}});$("#desc_type").change(function(){if($(this).val()==="Option"){$("#values-div").show();}else{$("#values-div").hide();}});});var map;var oms;var markers=[];var infowindow;var focusZoom=17;var locationMarker;var allResourceBounds;function markerListener(marker,event){$('.list-resource').removeClass('list-selected');$('#map').show();$('#resource-info').hide();var isResponsive=false;if($(window).width()<=singleColBreakpoint){isResponsive=true;listToMapSingleColumn();$('#map-footer').show();$('#map-footer').scrollTop(0);$('#right-column').height($('#map-list-grid').height());var totalHeight=$('#right-column').height()-15;$('#map-footer').height(totalHeight/3);$('#map').height(2*totalHeight/3);resizeMapListGrid();map.setCenter(marker.getPosition());map.setZoom(17);}
var markerInfoWindowTemplate=$("#marker-info-window-template").html();var compiledMarkerInfoWindowTemplate=Handlebars.compile(markerInfoWindowTemplate);var context={name:marker.title,address:marker.address,avg_rating:marker.avg_rating,responsive:isResponsive,};var markerInfo=compiledMarkerInfoWindowTemplate(context);if(infowindow){infowindow.close();}
if($(window).width()>singleColBreakpoint){infowindow=new google.maps.InfoWindow({content:markerInfo,maxWidth:300,});infowindow.open(map,marker);}else{$('#map-footer').html(markerInfo);$('#mobile-list-btn').click(function(){mapToListSingleColumn();});}
$(".more-info").click(function(){displayDetailedResourceView(marker);});}
function displayPhoneNumbers(descriptors){var PHONE_NUMBER_LENGTH=12;for(var desc in descriptors){if(desc.value){var updated=desc.value.replace(/(\d\d\d-\d\d\d-\d\d\d\d)/g,function replacePhoneNum(num){return"<a href=\"tel:+1-"+num+"\">"+num+"</a>";});$('#descriptor-value-'+desc.key).html(updated);}}}
function displayDetailedResourceView(marker){$.get('get-associations/'+marker.resourceID).done(function(associations){$("#map").hide();$('#map-footer').hide();$("#resource-info").empty();$("#resource-info").show();var associationObject=JSON.parse(associations);var descriptors=[];for(var key in associationObject){var value=associationObject[key];if(Array.isArray(associationObject[key])){value=Object.keys(value).map(function(key){return value[key];});value=value.join(', ');}
var descriptor={key:key,value:value};descriptors.push(descriptor);}
Handlebars.registerHelper('concat',function(str1,str2){return str1+str2;});var resourceTemplate=$("#resource-template").html();var compiledResourceTemplate=Handlebars.compile(resourceTemplate);var context={name:marker.title,address:marker.address,suggestionUrl:'suggestion/'+marker.resourceID,descriptors:descriptors,avg_rating:marker.avg_rating,requiredOpts:marker.requiredOpts,};var resourceInfo=compiledResourceTemplate(context);$("#resource-info").html(resourceInfo);displayPhoneNumbers(descriptors);$("#resource-info").scrollTop(0);$('#back-button').click(function(){$("#map").show();$("#resource-info").hide();if($(window).width()<=singleColBreakpoint){$('#map-footer').show();}
resizeMapListGrid();});$('.ui.rating').rating({initialRating:0,maxRating:5,onRate:function(value){if(value!==0){$('#submit-rating').removeClass('disabled').addClass('active');}}});$('#submit-rating').click(function(e){e.preventDefault();var rating=$('#rating-input').rating('get rating');var review=$('#review').val();var id=marker.resourceID;submitReview(rating,review,id);});$('#text-save-submit').click(function(e){var number=$('#phone-number').val();var id=marker.resourceID;sendText(number,id);});$('#sms-success-close').on('click',function(){$(this).closest('.message').transition('fade');});var singleResourceMap=new google.maps.Map(document.getElementById('single-resource-map'),{center:marker.getPosition(),zoom:focusZoom,scrollwheel:false,draggable:false,});var singleMarker=new google.maps.Marker({position:marker.getPosition(),map:singleResourceMap,});});}
function submitReview(rating,review,id){var ratingReview={'rating':rating,'review':review,'id':id,};$.ajax({url:'/rating-post',data:JSON.stringify(ratingReview),contentType:'application/json',dataType:'json',method:'POST'});$(".userRating").hide();$(".successMessage").show();}
function sendText(number,id){var twilioText={'number':number,'id':id};$.ajax({url:'/send-sms',data:JSON.stringify(twilioText),contentType:'application/json',dataType:'json',method:'POST',success:function(data){if(data.status=='success'){$(".textSentSuccess").show();}
else{alert('Invalid phone number');$("#phone-number").val('');}}});}
function initMap(){$("#resource-info").empty();$("#resource-info").hide();map=new google.maps.Map(document.getElementById('map'),{center:{lat:39.949,lng:-75.181},zoom:focusZoom,});oms=new OverlappingMarkerSpiderfier(map,{keepSpiderfied:true,nearbyDistance:10});oms.addListener('click',markerListener);infowindow=new google.maps.InfoWindow();initLocationSearch(map);initResourceSearch();initResetButton();$.get('/get-resources').done(function(resourcesString){var resources=JSON.parse(resourcesString);populateMarkers(resources);populateListDiv();});}
function initLocationSearch(map){var input=document.getElementById('pac-input');var autocomplete=new google.maps.places.Autocomplete(input);autocomplete.bindTo('bounds',map);autocomplete.addListener('place_changed',function(){infowindow.close();var place=autocomplete.getPlace();if(!place.geometry){window.alert("Autocomplete's returned place contains no geometry");return;}
var address='';if(place.address_components){address=[((place.address_components[0]&&place.address_components[0].short_name)||''),((place.address_components[1]&&place.address_components[1].short_name)||''),((place.address_components[2]&&place.address_components[2].short_name)||'')].join(' ');}
if(!locationMarker){locationMarker=new google.maps.Marker({map:map,position:place.geometry.location,icon:{path:google.maps.SymbolPath.CIRCLE,scale:8,strokeColor:'grey',fillColor:'black',fillOpacity:1,},});}else{locationMarker.setPosition(place.geometry.location);}
var searchedLocationInfoWindowTemplate=$("#searched-location-info-window-template").html();var compiledLocInfoWindowTemplate=Handlebars.compile(searchedLocationInfoWindowTemplate);var context={name:place.name,address:address,};var locationMarkerInfo=compiledLocInfoWindowTemplate(context);infowindow.setContent(locationMarkerInfo);infowindow.open(map,locationMarker);if($(window).width()<=singleColBreakpoint){listToMapSingleColumn();}});$('#pac-input').keyup(function(){if($(this).val()===""){locationMarker.setMap(null);locationMarker=null;}});}
function initResourceSearch(){$('#search-user-resources').click(function(){var query='?'+'name='+$('#resources-input').val();var requiredOptions=[];$("#search-resources-req-options :selected").each(function(){requiredOptions.push($(this).val());});for(var i=0;i<requiredOptions.length;i++){query+='&reqoption='+requiredOptions[i];}
var optionalOptions=[];$("#advanced-search select").each(function(){optionalOptions.push($(this).val());})
for(var i=0;i<optionalOptions.length;i++){query+='&optoption='+optionalOptions[i];}
var endpoint='/search-resources'+query;resourceSearchRequest(endpoint);});$('#resources-input').keyup(function(){if($(this).val().length===0){resourceSearchRequest('/get-resources');}});}
function initResetButton(){$('#reset-button').click(function(){$('#resources-input').val('');$('#search-resources-req-options').dropdown('clear');$('.search-resources-options').dropdown('clear');$(".ui.dropdown>.text").text("Choose option(s)");locationMarker.setMap(null);locationMarker=null;$('#pac-input').val('');resourceSearchRequest('/get-resources');});}
function resourceSearchRequest(endpoint){$.get(endpoint).done(function(resourcesString){for(var i=0;i<markers.length;i++){markers[i].setMap(null);}
markers=[];$('#map').show();var resources=JSON.parse(resourcesString);if(resources.length!=0){populateMarkers(resources);}
populateListDiv();});}
function populateMarkers(resources){for(var i=0;i<resources.length;i++){createMarker(resources[i]);}
var bounds=new google.maps.LatLngBounds();for(var i=0;i<markers.length;i++){markers[i].setMap(map);oms.addMarker(markers[i]);bounds.extend(markers[i].getPosition());}
map.fitBounds(bounds);map.setCenter(bounds.getCenter());allResourceBounds=bounds;}
function createMarker(resource){var markerToAdd=new google.maps.Marker({map:map});latLng=new google.maps.LatLng(resource.latitude,resource.longitude);markerToAdd.setPosition(latLng);markerToAdd.setVisible(true);markerToAdd.title=resource.name;markerToAdd.json_data={csrf_token:$('meta[name="csrf-token"]').prop('content'),data:resource.name};markerToAdd.avg_rating=resource.avg_rating;markerToAdd.resourceID=resource.id;markerToAdd.address=resource.address;markerToAdd.requiredOpts=resource.requiredOpts;markers.push(markerToAdd);}
function populateListDiv(){var markersToShow=markers;$("#list").empty();var listResources=[];$.each(markersToShow,function(i,markerToShow){var listResource={name:markerToShow.title,address:markerToShow.address,avg_rating:markerToShow.avg_rating,requiredOpts:markerToShow.requiredOpts,};listResources.push(listResource);});var listTemplate=$("#listview-template").html();var compiledListTemplate=Handlebars.compile(listTemplate);var context={resource:listResources,};var listView=compiledListTemplate(context);$("#list").html(listView);$(".list-resource").each(function(i,element){element.addEventListener('click',function(){markerListener(markersToShow[i],'click');$('.list-resource').removeClass('list-selected');if($(window).width()>singleColBreakpoint){$(this).addClass('list-selected');}});});}
function resizeMapListGrid(){var navHeight=$('.ui.navigation.grid').height();if($(window).width()<=singleColNoSpaceBreakpoint){$('#map-list-grid').height($('body').height()-navHeight-23);}else{$('#map-list-grid').height($('body').height()-navHeight-50);}
if($(window).width()>singleColBreakpoint){$('#map').height($('#map-list-grid').height());}
var center=map.getCenter();var zoom=map.getZoom();google.maps.event.trigger(map,"resize");map.setCenter(center);map.setZoom(zoom);}
function makeResponsive(){if($(window).width()<=singleColNoSpaceBreakpoint){singleColumnResets();$('#map-list-grid').removeClass('grid-space-large');$('#map-list-grid').addClass('grid-space-small');}else if($(window).width()>singleColNoSpaceBreakpoint&&$(window).width()<=singleColBreakpoint){singleColumnResets();$('#map-list-grid').removeClass('grid-space-small');$('#map-list-grid').addClass('grid-space-large');}else if($(window).width()>singleColBreakpoint&&$(window).width()<=twoColResizeBreakpoint){$('#left-column').removeClass().addClass('five wide column');$('#right-column').removeClass().addClass('eleven wide column');doubleColumnResets();}else if($(window).width()>twoColResizeBreakpoint){$('#left-column').removeClass().addClass('four wide column');$('#right-column').removeClass().addClass('twelve wide column');}}
function singleColumnResets(){$('#left-column').removeClass().addClass('sixteen wide column');$('#right-column').removeClass().addClass('sixteen wide column');if($('#right-column').is(':visible')&&$('#left-column').is(':visible')){$('#right-column').hide();setNavSwitching();}}
function setNavSwitching(){$('#nav-to-list').hide();$('#nav-to-map').show();$('#nav-to-map').click(function(){listToMapSingleColumn();});$('#nav-to-list').click(function(){mapToListSingleColumn();});}
function listToMapSingleColumn(){$('#left-column').hide();$('#right-column').show();$('#map').show();$('#map-footer').hide();$('#map').height($('#right-column').height());if(allResourceBounds){map.fitBounds(allResourceBounds);map.setCenter(allResourceBounds.getCenter());}
var center=map.getCenter();google.maps.event.trigger(map,"resize");map.setCenter(center);$('#nav-to-list').show();$('#nav-to-map').hide();if(infowindow){infowindow.close();}}
function mapToListSingleColumn(){$('#left-column').show();$('#right-column').hide();$('#nav-to-list').hide();$('#nav-to-map').show();}
function doubleColumnResets(){$('#map-list-grid').removeClass('grid-space-small');$('#map-list-grid').removeClass('grid-space-large');$('#map-footer').hide();$('#left-column').show();$('#right-column').show();$('.nav-mobile-switch').hide();if(allResourceBounds){map.fitBounds(allResourceBounds);map.setCenter(allResourceBounds.getCenter());}
var center=map.getCenter();google.maps.event.trigger(map,"resize");map.setCenter(center);}
$(document).ready(function(){$('#search-resources').click(searchQuery);$('#search-resources-text').keypress(function(e){if(e.which==13){e.preventDefault();searchQuery();}});$('#search-resources-text').keyup(function(){var requiredOptions=[];$("#search-resources-req-options :selected").each(function(){requiredOptions.push($(this).val());});if($(this).val().length===0&&requiredOptions.length===0){window.location.replace('/single-resource/');}});});function searchQuery(){var query='?name='+$('#search-resources-text').val();var requiredOptions=[];$("#search-resources-req-options :selected").each(function(){requiredOptions.push($(this).val());});for(var i=0;i<requiredOptions.length;i++){query+='&reqoption='+requiredOptions[i];}
var endpoint='/single-resource/search'+query;window.location.replace(endpoint);}
function initializeUpload(){$('.ui.radio.checkbox').checkbox();var csrftoken="{{ csrf_token() }}"
$('#upload-progress').progress();$('#csv-file').change(function(){$('#upload-button').removeClass('disabled').addClass('active');});$("#csv-upload-form").submit(function(event){event.preventDefault();$("#status-success").empty();$("#status-errors").empty();$('#upload-progress').progress();$('#upload-progress').show();parseCSV();});}
function parseCSV(){var numRows=0;var numFields=0;var errorList=[];var rowObjects=[];var fields;$("#csv-file").parse({config:{delimiter:",",header:true,skipEmptyLines:true,step:function(row,parser){if(numRows==0){fields=row.meta.fields.map(function(e){return e.trim();}).filter(function(e){return e!=='';});numFields=fields.length;var nameColumnIndex=fields.indexOf("Name");if(nameColumnIndex==-1){errorList.push("'Name' is a required column name.");}
var addressColumnIndex=fields.indexOf("Address");if(addressColumnIndex==-1){errorList.push("'Address' is a required column name.");}
if(errorList.length>0){parser.abort();}}
row=JSON.parse(JSON.stringify(row.data[0]).replace(/"\s+|\s+"/g,'"'));var rowValues=Object.keys(row).filter(function(e){return row[e]!=='';});if(rowValues.length!=0){var rowNum=numRows+2
if(row['Name']===''){errorList.push("Row "+(rowNum)
+" is missing a required 'Name' value.");}
if(row['Address']===''){errorList.push("Row "+(rowNum)
+" is missing a required 'Address' value.");}
var rowColumns=Object.keys(row).filter(function(e){return e!=='';});if(rowColumns.length!=numFields){errorList.push("Row "+(rowNum)
+" has the incorrect number of columns: "+rowColumns.length
+". Expected: "+numFields);}
rowObjects.push(row);numRows++;}},},error:function(error,file){displayErrors([error]);},complete:function(){if(errorList.length>0){displayErrors(errorList);}else{submitCsvData(numRows,rowObjects,fields);}},});}
function displayErrors(errorList){for(var i=0;i<errorList.length;i++){$("#status-errors").append("<div class='item'>"+errorList[i]+"</div>");}
$('#upload-progress').progress('set error');}
function submitCsvData(numRows,rowObjects,fields){var ajaxReqs=[];var resetOrUpdate=document.getElementById('reset').checked?'reset':'update';if(resetOrUpdate==='reset'){ajaxReqs.push({action:'fields-reset',fields:fields,});}else{ajaxReqs.push({action:'fields-update',fields:fields,});}
if(rowObjects.length>0){var action=resetOrUpdate==='reset'?'reset-update':'update';rowObjects.forEach(function(obj){ajaxReqs.push({action:action,row:obj,});});}
ajaxReqs.push({action:'finished',});var moveToNextStep=true;function DeferredAjax(opts){this.options=opts;this.deferred=$.Deferred();this.action=opts.action;this.row=opts.row;this.fields=opts.fields;this.count=opts.count;}
DeferredAjax.prototype.invoke=function(){var self=this;var data={action:self.action,row:self.row,fields:self.fields,count:self.count,};return $.ajax({type:"POST",url:"/bulk-resource/_upload",data:{json:JSON.stringify(data)},dataType:"JSON",success:function(res){if(res.redirect){window.location.href=res.redirect;}
if(res.status==='Success'){$("#status-success").append("<div class='item'>"+res.message+"</div>");}else if(res.status==='Error'){$("#status-errors").append("<div class='item'>"+res.message+"</div>");moveToNextStep=false;}
self.deferred.resolve();},error:function(res,err,msg){$("#status-errors").append("<div class='item'>There was an unexpected error. "+
"Please try again.</div>");$('#upload-progress').progress('set error');},});}
DeferredAjax.prototype.promise=function(){return this.deferred.promise();}
var numReqs=ajaxReqs.length;$('#upload-progress').progress('set total',numReqs);prevAjax=$.Deferred();prevAjax.resolve();$.each(ajaxReqs,function(idx,el){var nextAjax=new DeferredAjax({action:el.action,row:el.row,fields:el.fields,count:idx,});$.when(prevAjax).then(function(){$('#upload-progress').progress('increment',1);if(el.action==='finished'&&!moveToNextStep){$('#upload-progress').progress('set error');}else{nextAjax.invoke();}},function(){nextAjax.abort();});prevAjax=nextAjax;});}